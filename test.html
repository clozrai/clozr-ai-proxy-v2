<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CLOZR AI - Test Client</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #111;
      color: white;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      cursor: pointer;
    }
    .log {
      margin-top: 20px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>CLOZR AI Test Client</h1>
  <button id="startBtn">🎙️ Start Mic Stream</button>
  <div class="log" id="log"></div>

  <script>
    const log = (msg) => {
      const el = document.getElementById("log");
      el.textContent += msg + "\n";
      console.log(msg);
    };

    document.getElementById("startBtn").onclick = async () => {
      log("🔐 Requesting microphone access...");

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        log("✅ Microphone access granted!");

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
        const source = audioCtx.createMediaStreamSource(stream);
        const processor = audioCtx.createScriptProcessor(4096, 1, 1);

        const socket = new WebSocket("ws://https://clozr-ai-proxy-v2.onrender.com");

        socket.onopen = () => {
          log("🔗 Connected to CLOZR AI proxy");

          processor.onaudioprocess = (event) => {
            const input = event.inputBuffer.getChannelData(0);
            const pcm = new Int16Array(input.length);
            for (let i = 0; i < input.length; i++) {
              const s = Math.max(-1, Math.min(1, input[i]));
              pcm[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            socket.send(pcm.buffer);
            log("📤 Sent PCM chunk");
          };

          source.connect(processor);
          processor.connect(audioCtx.destination);
        };

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.transcript) {
            log("🧠 Deepgram said: " + data.transcript);
          }
        };

        socket.onerror = () => log("❌ WebSocket error");
        socket.onclose = () => log("🔁 WebSocket closed");
      } catch (err) {
        log("🚫 Microphone access denied or error occurred: " + err.message);
      }
    };
  </script>
</body>
</html>
